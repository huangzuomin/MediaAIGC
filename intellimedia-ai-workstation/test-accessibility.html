<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可访问性和兼容性测试 - 智媒AI工作站</title>
    <link rel="stylesheet" href="assets/styles.css">
    <style>
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .test-title {
            color: #003366;
            margin-bottom: 1rem;
        }
        
        .test-result {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 4px;
        }
        
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="skip-links">
        <a href="#main-content" class="skip-link">跳转到主要内容</a>
    </div>

    <main id="main-content" class="container" style="padding: 2rem;">
        <h1>可访问性和浏览器兼容性测试</h1>
        
        <div class="test-section">
            <h2 class="test-title">浏览器兼容性测试</h2>
            <div id="browser-compatibility-results"></div>
        </div>
        
        <div class="test-section">
            <h2 class="test-title">可访问性测试</h2>
            <div id="accessibility-results"></div>
        </div>
        
        <div class="test-section">
            <h2 class="test-title">键盘导航测试</h2>
            <p>使用Tab键测试以下元素的焦点导航：</p>
            <button class="btn btn-primary">按钮1</button>
            <button class="btn btn-secondary">按钮2</button>
            <a href="#test" class="btn btn-primary">链接按钮</a>
            
            <form style="margin-top: 1rem;">
                <div class="form-group">
                    <label for="test-input" class="form-label">测试输入框 <span class="required-indicator">*</span></label>
                    <input type="text" id="test-input" required aria-describedby="test-input-desc">
                    <div id="test-input-desc" class="field-description">这是一个必填的测试输入框</div>
                </div>
                
                <div class="form-group">
                    <label for="test-select" class="form-label">测试选择框</label>
                    <select id="test-select">
                        <option value="">请选择</option>
                        <option value="1">选项1</option>
                        <option value="2">选项2</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">提交测试</button>
            </form>
        </div>
        
        <div class="test-section">
            <h2 class="test-title">ARIA测试</h2>
            <div role="tablist" aria-label="测试选项卡">
                <button role="tab" aria-selected="true" aria-controls="panel1" id="tab1">选项卡1</button>
                <button role="tab" aria-selected="false" aria-controls="panel2" id="tab2">选项卡2</button>
            </div>
            
            <div role="tabpanel" id="panel1" aria-labelledby="tab1">
                <p>这是选项卡1的内容</p>
            </div>
            
            <div role="tabpanel" id="panel2" aria-labelledby="tab2" hidden>
                <p>这是选项卡2的内容</p>
            </div>
            
            <button onclick="testScreenReaderAnnouncement()">测试屏幕阅读器公告</button>
        </div>
        
        <div class="test-section">
            <h2 class="test-title">工具提示测试</h2>
            <p>将鼠标悬停在下面的元素上查看工具提示：</p>
            <span data-tooltip="这是一个工具提示示例">悬停查看提示</span>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/utils/browserCompatibility.js"></script>
    <script src="js/utils/accessibility.js"></script>
    
    <script>
        // 等待页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 等待兼容性管理器初始化
            setTimeout(runTests, 1000);
        });
        
        function runTests() {
            runBrowserCompatibilityTests();
            runAccessibilityTests();
            setupTabNavigation();
        }
        
        function runBrowserCompatibilityTests() {
            const resultsContainer = document.getElementById('browser-compatibility-results');
            
            if (window.BrowserCompatibility) {
                const compatibility = window.BrowserCompatibility;
                const report = compatibility.getCompatibilityReport();
                
                resultsContainer.innerHTML = `
                    <div class="test-result test-pass">
                        <strong>浏览器兼容性管理器已加载</strong>
                    </div>
                    <div class="test-result test-info">
                        <strong>浏览器信息：</strong> ${report.browser.name} ${report.browser.version}
                    </div>
                    <div class="test-result test-info">
                        <strong>平台：</strong> ${report.browser.mobile ? '移动端' : '桌面端'}
                    </div>
                    <div class="test-result test-info">
                        <strong>已加载的Polyfills：</strong> ${report.loadedPolyfills.length > 0 ? report.loadedPolyfills.join(', ') : '无'}
                    </div>
                    <div class="test-result ${report.warnings.length > 0 ? 'test-fail' : 'test-pass'}">
                        <strong>兼容性警告：</strong> ${report.warnings.length > 0 ? report.warnings.join('; ') : '无警告'}
                    </div>
                `;
                
                // 测试特性支持
                const features = ['flexbox', 'cssGrid', 'cssVariables', 'fetch', 'promises'];
                features.forEach(feature => {
                    const supported = compatibility.isFeatureSupported(feature);
                    const resultDiv = document.createElement('div');
                    resultDiv.className = `test-result ${supported ? 'test-pass' : 'test-fail'}`;
                    resultDiv.innerHTML = `<strong>${feature}：</strong> ${supported ? '支持' : '不支持'}`;
                    resultsContainer.appendChild(resultDiv);
                });
                
            } else {
                resultsContainer.innerHTML = `
                    <div class="test-result test-fail">
                        <strong>浏览器兼容性管理器未加载</strong>
                    </div>
                `;
            }
        }
        
        function runAccessibilityTests() {
            const resultsContainer = document.getElementById('accessibility-results');
            
            if (window.AccessibilityManager) {
                const accessibility = window.AccessibilityManager;
                const report = accessibility.getAccessibilityReport();
                
                resultsContainer.innerHTML = `
                    <div class="test-result test-pass">
                        <strong>可访问性管理器已加载</strong>
                    </div>
                    <div class="test-result test-info">
                        <strong>可聚焦元素数量：</strong> ${report.focusableElements}
                    </div>
                    <div class="test-result ${report.missingAltText > 0 ? 'test-fail' : 'test-pass'}">
                        <strong>缺少alt文本的图片：</strong> ${report.missingAltText}
                    </div>
                    <div class="test-result ${report.missingLabels > 0 ? 'test-fail' : 'test-pass'}">
                        <strong>缺少标签的输入框：</strong> ${report.missingLabels}
                    </div>
                    <div class="test-result test-info">
                        <strong>屏幕阅读器公告次数：</strong> ${report.screenReaderAnnouncements}
                    </div>
                    <div class="test-result ${report.keyboardNavigationEnabled ? 'test-pass' : 'test-fail'}">
                        <strong>键盘导航：</strong> ${report.keyboardNavigationEnabled ? '已启用' : '未启用'}
                    </div>
                `;
                
            } else {
                resultsContainer.innerHTML = `
                    <div class="test-result test-fail">
                        <strong>可访问性管理器未加载</strong>
                    </div>
                `;
            }
        }
        
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('[role="tab"]');
            const panels = document.querySelectorAll('[role="tabpanel"]');
            
            tabs.forEach((tab, index) => {
                tab.addEventListener('click', () => {
                    // 重置所有选项卡
                    tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
                    panels.forEach(p => p.hidden = true);
                    
                    // 激活当前选项卡
                    tab.setAttribute('aria-selected', 'true');
                    const panelId = tab.getAttribute('aria-controls');
                    document.getElementById(panelId).hidden = false;
                });
                
                tab.addEventListener('keydown', (e) => {
                    let targetIndex;
                    
                    if (e.key === 'ArrowRight') {
                        targetIndex = (index + 1) % tabs.length;
                    } else if (e.key === 'ArrowLeft') {
                        targetIndex = (index - 1 + tabs.length) % tabs.length;
                    } else {
                        return;
                    }
                    
                    e.preventDefault();
                    tabs[targetIndex].focus();
                    tabs[targetIndex].click();
                });
            });
        }
        
        function testScreenReaderAnnouncement() {
            if (window.AccessibilityManager) {
                window.AccessibilityManager.announceToScreenReader('这是一个测试公告消息', 'polite');
                alert('屏幕阅读器公告已发送（检查控制台或使用屏幕阅读器）');
            } else {
                alert('可访问性管理器未加载');
            }
        }
        
        // 表单验证测试
        document.querySelector('form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const input = document.getElementById('test-input');
            if (!input.value.trim()) {
                // 显示错误
                let errorElement = document.getElementById('test-input-error');
                if (!errorElement) {
                    errorElement = document.createElement('div');
                    errorElement.id = 'test-input-error';
                    errorElement.className = 'field-error';
                    errorElement.setAttribute('role', 'alert');
                    input.parentNode.appendChild(errorElement);
                }
                errorElement.textContent = '此字段为必填项';
                input.setAttribute('aria-invalid', 'true');
                input.setAttribute('aria-describedby', 'test-input-desc test-input-error');
                
                // 公告错误
                if (window.AccessibilityManager) {
                    window.AccessibilityManager.announceToScreenReader('表单验证失败：此字段为必填项', 'assertive');
                }
            } else {
                // 清除错误
                const errorElement = document.getElementById('test-input-error');
                if (errorElement) {
                    errorElement.remove();
                }
                input.removeAttribute('aria-invalid');
                input.setAttribute('aria-describedby', 'test-input-desc');
                
                // 公告成功
                if (window.AccessibilityManager) {
                    window.AccessibilityManager.announceToScreenReader('表单提交成功', 'polite');
                }
                
                alert('表单验证通过！');
            }
        });
    </script>
</body>
</html>